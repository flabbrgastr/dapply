<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Performers Statistics</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f5f5f5;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
                background-color: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            h1,
            h2 {
                color: #333;
                text-align: center;
            }
            .nav-bar {
                text-align: center;
                margin-bottom: 20px;
            }
            .nav-bar a {
                display: inline-block;
                padding: 10px 20px;
                margin: 0 10px;
                background-color: #007bff;
                color: white;
                text-decoration: none;
                border-radius: 5px;
            }
            .nav-bar a:hover {
                background-color: #0056b3;
            }
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .stat-card {
                background-color: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            .stat-number {
                font-size: 32px;
                font-weight: bold;
                color: #007bff;
            }
            .stat-label {
                font-size: 16px;
                color: #666;
                margin-top: 5px;
            }
            .charts-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 30px;
            }
            .chart-card {
                background-color: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            .table-container {
                margin-top: 30px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }
            th,
            td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
            th {
                background-color: #f2f2f2;
            }
            tr:hover {
                background-color: #f5f5f5;
            }
            .section-title {
                color: #007bff;
                border-bottom: 2px solid #007bff;
                padding-bottom: 5px;
                margin-top: 30px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Performers Database Statistics</h1>

            <div class="nav-bar">
                <a href="/">Back to Performers View</a>
                <a href="/stats">Refresh Stats</a>
            </div>

            <div class="stats-grid" id="stats-summary">
                <div class="stat-card">
                    <div class="stat-number" id="total-performers">0</div>
                    <div class="stat-label">Total Performers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="rated-performers">0</div>
                    <div class="stat-label">With Ratings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avg-rating">0.0</div>
                    <div class="stat-label">Avg Rating</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unrated-performers">0</div>
                    <div class="stat-label">Without Rating</div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3>Rating Distribution</h3>
                    <canvas
                        id="rating-distribution-chart"
                        height="200"
                    ></canvas>
                </div>
                <div class="chart-card">
                    <h3>Top-Rated Performers</h3>
                    <canvas id="top-rated-chart" height="200"></canvas>
                </div>
            </div>

            <div class="table-container">
                <h2 class="section-title">Top 10 Rated Performers</h2>
                <table id="top-rated-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Rating</th>
                            <th>Crawls</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="top-rated-body"></tbody>
                </table>
            </div>

            <div class="table-container">
                <h2 class="section-title">Bottom 10 Rated Performers</h2>
                <table id="bottom-rated-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Rating</th>
                            <th>Crawls</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="bottom-rated-body"></tbody>
                </table>
            </div>

            <div class="table-container">
                <h2 class="section-title">Most Crawled Performers</h2>
                <table id="most-crawled-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Crawls</th>
                            <th>Rating</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="most-crawled-body"></tbody>
                </table>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            let statsData = {};

            // Load stats when page loads
            document.addEventListener("DOMContentLoaded", function () {
                loadStats();
            });

            function loadStats() {
                fetch("/api/stats")
                    .then((response) => response.json())
                    .then((data) => {
                        statsData = data;

                        // Update summary stats
                        document.getElementById(
                            "total-performers",
                        ).textContent = data.total_performers;
                        document.getElementById(
                            "rated-performers",
                        ).textContent = data.rated_performers;
                        document.getElementById("avg-rating").textContent =
                            data.avg_rating;
                        document.getElementById(
                            "unrated-performers",
                        ).textContent =
                            data.total_performers - data.rated_performers;

                        // Render tables
                        renderTopRatedTable(data.top_rated);
                        renderBottomRatedTable(data.bottom_rated);
                        renderMostCrawledTable(data.most_crawled);

                        // Render charts
                        renderRatingDistributionChart(data.rating_distribution);
                        renderTopRatedChart(data.top_rated.slice(0, 5)); // Show top 5 for chart
                    })
                    .catch((error) =>
                        console.error("Error loading stats:", error),
                    );
            }

            function renderTopRatedTable(performers) {
                const tbody = document.getElementById("top-rated-body");
                tbody.innerHTML = "";

                performers.forEach((performer) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${performer.id}</td>
                    <td>${performer.name}</td>
                    <td>${performer.rating || "N/A"}</td>
                    <td>${performer.crawls || 0}</td>
                    <td>${performer.last_updated || ""}</td>
                `;
                    tbody.appendChild(row);
                });
            }

            function renderBottomRatedTable(performers) {
                const tbody = document.getElementById("bottom-rated-body");
                tbody.innerHTML = "";

                performers.forEach((performer) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${performer.id}</td>
                    <td>${performer.name}</td>
                    <td>${performer.rating || "N/A"}</td>
                    <td>${performer.crawls || 0}</td>
                    <td>${performer.last_updated || ""}</td>
                `;
                    tbody.appendChild(row);
                });
            }

            function renderMostCrawledTable(performers) {
                const tbody = document.getElementById("most-crawled-body");
                tbody.innerHTML = "";

                performers.forEach((performer) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${performer.id}</td>
                    <td>${performer.name}</td>
                    <td>${performer.crawls || 0}</td>
                    <td>${performer.rating || "N/A"}</td>
                    <td>${performer.last_updated || ""}</td>
                `;
                    tbody.appendChild(row);
                });
            }

            function renderRatingDistributionChart(distribution) {
                const ctx = document
                    .getElementById("rating-distribution-chart")
                    .getContext("2d");

                const labels = distribution.map((item) => item.range);
                const counts = distribution.map((item) => item.count);

                new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Number of Performers",
                                data: counts,
                                backgroundColor: "rgba(54, 162, 235, 0.6)",
                                borderColor: "rgba(54, 162, 235, 1)",
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: "Count",
                                },
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: "Rating Range",
                                },
                            },
                        },
                    },
                });
            }

            function getAlphabeticalRatingValue(rating) {
                if (!rating) return 0;

                const ratingUpper = rating.toUpperCase().trim();

                // Handle numeric ratings
                const numericRating = parseFloat(rating);
                if (!isNaN(numericRating)) return numericRating;

                // Handle alphabetical ratings
                if (ratingUpper.startsWith("AAA")) {
                    if (ratingUpper.includes("+")) return 110;
                    if (ratingUpper.includes("-")) return 108;
                    return 109;
                } else if (ratingUpper.startsWith("AA")) {
                    if (ratingUpper.includes("+")) return 106;
                    if (ratingUpper.includes("-")) return 104;
                    return 105;
                } else if (ratingUpper.startsWith("A")) {
                    if (ratingUpper.includes("+")) return 102;
                    if (ratingUpper.includes("-")) return 100;
                    return 101;
                } else if (ratingUpper.startsWith("BBB")) {
                    if (ratingUpper.includes("+")) return 98;
                    if (ratingUpper.includes("-")) return 96;
                    return 97;
                } else if (ratingUpper.startsWith("BB")) {
                    if (ratingUpper.includes("+")) return 94;
                    if (ratingUpper.includes("-")) return 92;
                    return 93;
                } else if (ratingUpper.startsWith("B")) {
                    if (ratingUpper.includes("+")) return 90;
                    if (ratingUpper.includes("-")) return 88;
                    return 89;
                } else if (ratingUpper.startsWith("CCC")) {
                    if (ratingUpper.includes("+")) return 86;
                    if (ratingUpper.includes("-")) return 84;
                    return 85;
                } else if (ratingUpper.startsWith("CC")) {
                    if (ratingUpper.includes("+")) return 82;
                    if (ratingUpper.includes("-")) return 80;
                    return 81;
                } else if (ratingUpper.startsWith("C")) {
                    if (ratingUpper.includes("+")) return 78;
                    if (ratingUpper.includes("-")) return 76;
                    return 77;
                } else if (ratingUpper.startsWith("DDD")) {
                    if (ratingUpper.includes("+")) return 74;
                    if (ratingUpper.includes("-")) return 72;
                    return 73;
                } else if (ratingUpper.startsWith("DD")) {
                    if (ratingUpper.includes("+")) return 70;
                    if (ratingUpper.includes("-")) return 68;
                    return 69;
                } else if (ratingUpper.startsWith("D")) {
                    if (ratingUpper.includes("+")) return 66;
                    if (ratingUpper.includes("-")) return 64;
                    return 65;
                } else if (ratingUpper.startsWith("EEE")) {
                    if (ratingUpper.includes("+")) return 62;
                    if (ratingUpper.includes("-")) return 60;
                    return 61;
                } else if (ratingUpper.startsWith("EE")) {
                    if (ratingUpper.includes("+")) return 58;
                    if (ratingUpper.includes("-")) return 56;
                    return 57;
                } else if (ratingUpper.startsWith("E")) {
                    if (ratingUpper.includes("+")) return 54;
                    if (ratingUpper.includes("-")) return 52;
                    return 53;
                } else {
                    return 40; // Default value for unrecognized ratings
                }
            }

            function renderTopRatedChart(performers) {
                const ctx = document
                    .getElementById("top-rated-chart")
                    .getContext("2d");

                const labels = performers.map(
                    (p) =>
                        p.name.substring(0, 15) +
                        (p.name.length > 15 ? "..." : ""),
                ); // Shorten names
                const ratings = performers.map((p) =>
                    getAlphabeticalRatingValue(p.rating),
                );

                // Determine the max value for the chart scale
                const maxValue = Math.max(...ratings, 10);

                new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Rating Value",
                                data: ratings,
                                backgroundColor: "rgba(75, 192, 192, 0.6)",
                                borderColor: "rgba(75, 192, 192, 1)",
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        indexAxis: "y",
                        responsive: true,
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: maxValue,
                                title: {
                                    display: true,
                                    text: "Rating Scale Value",
                                },
                            },
                        },
                    },
                });
            }
        </script>
    </body>
</html>
